{% extends 'shelter/base.html' %}
{% load static %}

{% block title %}–ù–∞—à–∏ –ø–∏—Ç–æ–º—Ü—ã - –ü—Ä–∏—é—Ç "–î–æ–±—Ä—ã–µ –õ–∞–ø—ã"{% endblock %}

{% block content %}
<section class="container mx-auto px-4 py-12">
    <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">–ù–∞—à–∏ –ü–∏—Ç–æ–º—Ü—ã</h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            –ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç —Å–≤–æ–µ–≥–æ –¥–æ–º–∞. –ö–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö –æ—Å–æ–±–µ–Ω–Ω—ã–π.
        </p>
    </div>

    <!-- Search & Filters -->
    <div class="max-w-4xl mx-auto mb-12">
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="space-y-4">
                <input type="text" id="animal-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–∏–ø—É..." class="form-input w-full p-3 rounded-lg border" value="{{ search_query|default:'' }}">
                
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">–¢–∏–ø –∂–∏–≤–æ—Ç–Ω–æ–≥–æ</label>
                        <select name="animal_type" class="form-select w-full p-2 rounded border">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="dog" {% if animal_type == 'dog' %}selected{% endif %}>–°–æ–±–∞–∫–∏</option>
                            <option value="cat" {% if animal_type == 'cat' %}selected{% endif %}>–ö–æ—à–∫–∏</option>
                            <option value="other" {% if animal_type == 'other' %}selected{% endif %}>–î—Ä—É–≥–∏–µ</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                        <select name="age" class="form-select w-full p-2 rounded border">
                            <option value="">–õ—é–±–æ–π –≤–æ–∑—Ä–∞—Å—Ç</option>
                            <option value="young" {% if age == 'young' %}selected{% endif %}>–î–æ 1 –≥–æ–¥–∞</option>
                            <option value="adult" {% if age == 'adult' %}selected{% endif %}>1-7 –ª–µ—Ç</option>
                            <option value="senior" {% if age == 'senior' %}selected{% endif %}>–°—Ç–∞—Ä—à–µ 7 –ª–µ—Ç</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select name="status" class="form-select w-full p-2 rounded border">
                            <option value="">–í—Å–µ</option>
                            <option value="available" {% if status == 'available' %}selected{% endif %}>–î–æ—Å—Ç—É–ø–Ω—ã</option>
                            <option value="reserved" {% if status == 'reserved' %}selected{% endif %}>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã</option>
                        </select>
                    </div>
                </div>

                {% url 'animals_list' as animals_url %}
                <button type="button" onclick="window.location.href='{{ animals_url }}'" class="text-purple-600 hover:text-purple-700 font-semibold mt-4">
                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>

    <!-- Animals Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for animal in animals %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <a href="{% url 'animal_detail' animal.id %}">
                {% if animal.image %}
                <img src="{{ animal.image.url }}" alt="{{ animal.name }}" class="w-full h-48 object-cover">
                {% else %}
                <div class="flex items-center justify-center h-48 text-6xl">üêæ</div>
                {% endif %}
            </a>
            <div class="p-4">
                <h3 class="font-bold text-xl mb-2">{{ animal.name }}</h3>

                <!-- –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                {% if animal.is_booked %}
                    <button disabled class="mt-2 w-full bg-gray-400 text-white py-2 rounded">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω</button>
                {% else %}
                    {% if user.is_authenticated %}
                        <button onclick="bookAppointment('{{ animal.id }}')" class="mt-2 w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">
                            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É
                        </button>
                    {% else %}
                        <a href="{% url 'login' %}?next={% url 'animal_detail' animal.id %}" class="mt-2 w-full block bg-purple-600 text-white py-2 rounded text-center hover:bg-purple-700">
                            –í–æ–π–¥–∏—Ç–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                        </a>
                    {% endif %}
                {% endif %}

                <!-- –°—Ç–∞—Ç—É—Å –∂–∏–≤–æ—Ç–Ω–æ–≥–æ -->
                <span class="text-sm mt-2 {% if animal.status == 'free' %}text-green-600{% else %}text-yellow-600{% endif %}">
                    {% if animal.status == 'free' %}–î–æ—Å—Ç—É–ø–µ–Ω{% else %}–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω{% endif %}
                </span>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12">
            <h3 class="text-2xl font-bold text-gray-700 mb-2">–ü–∏—Ç–æ–º—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p class="text-gray-600 mb-6">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            <a href="{% url 'animals_list' %}" class="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function bookAppointment(animalId) {
    animalId = parseInt(animalId);
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É —Å —ç—Ç–∏–º –ø–∏—Ç–æ–º—Ü–µ–º?')) {
        fetch(`/api/adoptions/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ animal_id: animalId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('–í—Å—Ç—Ä–µ—á–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞!');
                window.location.reload();
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        })
        .catch(e => alert('–û—à–∏–±–∫–∞!'));
    }
}
</script>
{% endblock %}
